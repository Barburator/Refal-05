Язык Рефал-05, его отличия от Рефала-5 и общее подмножество
===========================================================

Синтаксис Рефала-05
-------------------

Синтаксис внешне похож на классический Рефал-5 (версия `PZ Oct 29 2004`),
но с некоторыми тонкими отличиями. Программисты, знакомые с Рефалом-5, могут
пробежать глазами этот раздел, обращая лишь внимание на эти отличия (они будут
выделены **жирным** шрифтом).

Программа на Рефале-05 состоит из нескольких единиц трансляции — исходных
файлов на Рефале и на Си. Компилятор каждый исходный файл на Рефале транслирует
в файл на языке Си (сохраняя его в той же папке и с тем же именем), после
чего вызывает компилятор языка Си для сборки исполнимого файла (подробнее —
в руководстве пользователя <!--TODO-->). Каждая единица трансляции на Рефале
компилируется независимо.

Программа на Рефале записывается в свободном синтаксисе, т.е. переводы строк
являются обычными разделителями, наряду с пробелами и табуляциями. Пробельные
символы могут вставляться между любыми лексемами языка, обязательны лишь там,
где их отсутствие приведёт к склеиванию лексем (например, пара чисел `10 20`,
разделённая пробелом, склеится в одно число `1020`). Внутри цепочек литер
(см. далее) пробелы уже значимы — интерпретируются как литеры со значением
«пробел».

На месте любого пробельного символа можно записать комментарий. Комментарии
могут быть двух видов: однострочные и многострочные. Однострочные комментарии —
это строки программы, самым первым символом которой является знак `*`.
Многострочные комментарии такие же как в Си: начинаются с `/*` и заканчиваются
на `*/`. Многострочные комментарии не могут быть вложенными. Даже более того,
внутри многострочных комментариев запрещена последовательность символов `/*`
(чтобы предотвратить попытки закомментировать код, уже содержащий комментарий).

Компилятор обычно игнорирует содержимое комментариев, за исключением двух
случаев. Во-первых, как уже сказано, просматривается содержимое многострочных
комментариев — проверяется, что внутри них нет знаков `/*`. Во-вторых, есть
так называемые _псевдокомментарии,_ которые на самом деле комментариями
не являются. Но о них позже.


### Имена функций, объявления и определения

Файл исходного текста на Рефале состоит из набора объявлений и определений
функций. Определение функции описывает саму функцию, объявление функции
говорит о том, что где-то в программе (как правило, в другой единице трансляции)
определена функция с этим именем. Объявление функции, определённой в том же
файле, совершенно бесполезно, однако, синтаксической ошибкой не является.

**Имена функций** имеют примерно тот же вид, что и в других языках
программирования: начинаются с латинской буквы и состоят из латинских букв,
цифр, знаков прочерка _и знаков минуса,_ при этом знаки минуса и прочерка
взаимозаменяемы, имена чувствительны к регистру. Примеры: `Go`, `fact`,
`R05-Generate-ToFile`, `findfile_AnalyzeFile-ByFolders`. Три разных имени
функции: `ABC`, `Abc` и `abc`, поскольку имена чувствительны к регистру.
Одно и то же имя функции: `A_b-c` и `A-b_c`, поскольку знаки `-` и `_`
взаимозаменяемы. Рефал-05 длину имён функций не ограничивает, однако,
нижележащий компилятор языка Си может рассматривать как значимые только
первые `N` символов (где величина `N` зависит от компилятора).

**Отличие от Рефала-5.** Знаки `-` и `_` в именах функций взаимозаменяемы.

Объявление функции имеет вид:

    $EXTERN Имя;

Здесь ключевое слово `$EXTERN` говорит о том, что эта функция определена где-то
ещё, после ключевого слова записывается имя функции.

Рефал-05 — динамически типизированный язык, все функции принимают и возвращают
произвольное объектное выражение (см. далее). Поэтому в объявлени ничего, кроме
имени, указывать не надо.

После ключевого слова `$EXTERN` можно указывать несколько имён функций:

    $EXTERN Имя1, Имя2, Имя3;

Это то же самое, что и

    $EXTERN Имя1;
    $EXTERN Имя2;
    $EXTERN Имя3;

**Отличие от Рефала-5.** В Рефале-5 можно использовать ключевые слова `$EXTERN`,
`$EXTRN` и `$EXTERNAL`. В Рефале-05 — только `$EXTERN`.

Определение функции в общем случае имеет вид:

    ИмяФункции {
      тело-функции
    }

или

    $ENTRY ИмяФункции {
      тело-функции
    }

Если функция определена без ключевого слова `$ENTRY`, то её область видимости
ограничена тем файлом, где она находится — _по имени_ к ней обратиться можно
только в текущем файле. Если функция определена с использованием ключевого
слова `$ENTRY`, то она находится в _глобальной области видимости_ — на неё
можно сослаться из других файлов при помощи ключевого слова `$EXTERN`. Будем
говорить об области видимости файла как о _локальной области видимости,_
функции, помеченные словом `$ENTRY` будем называть _entry-функциями,_ без этого
ключевого слова — _локальными функциями._ Entry-функции одновременно находятся
и в глобальной области видимости всей программы, и в локальной области видимости
файла, где они определены.

Теперь можно точнее сформулировать семантику ключевого слова `$EXTERN`: оно
используется для того, чтобы добавить указанные имена функций из глобальной
области видимости в локальную.

В коде на языке Си локальные функции соответствуют определениям, записанным
с использованием ключевого слова `static`, entry-функции — определениям без
ключевого слова `static`. Объявления внешних функций (но только тех, которые
используются), компилируются в `extern`’ы. Тонкости кодогенерации мы рассмотрим
в одной из следующих глав. <!--TODO-->

Функция в Рефале-05 может быть написана как на Рефале, так и на языке Си (при
помощи синтаксиса _нативных вставок)._ В этом разделе мы будем рассматривать
только функции, написанные на Рефале.

**Отличие от Рефала-5.** Тело функции может быть записано на языке Си, см. одну
из следующих глав. <!--TODO-->

_Тело функции_ представляет собой набор из нескольких предложений — правил
вычисления функции:

    ИмяФункции {
      предложение1;
      предложение2;
      …
      предложениеN;
    }

В конце каждого предложения пишется точка с запятой, при этом в конце последнего
предложения точку с запятой допустимо не ставить.

_Предложение_ состоит из двух частей — образца и результата, которые разделяются
знаком равенства:

    образец = результат;

_Образец_ описывает подмножество значений аргумента, для которого применимо
данное предложение, _результат_ — как должна вычисляться функция на данном
подмножестве. Образец также называют _образцовым выражением_ или _левой частью,_
результат — _результатным выражением_ или _правой частью._

Объединение множеств значений аргумента, описываемых каждым из образцов,
образует область определения функции с учётом вызовов других функций в правых
частях.

Аргумент сопоставляется с образцами сверху вниз, срабатывает правая часть
у первого образца с которым удалось _отождествить_ аргумент функции. Если
такого образца не нашлось, программа аварийно останавливается с выдачей ошибки
_«отождествление невозможно»_ (recognition impossible).

Рефал-05 допускает функции с пустым телом — когда между фигурными скобками
не записано ни одного предложения. Такие функции аварийно останавливаются
при любом аргументе. Просто потому, что нет подходящего предложения, потому что
предложений вообще нет.

**Отличие от Рефала-5.** Рефал-5 не допускает функции без предложений, Рефал-05
допускает.

На первый взгляд может показаться, что такие функции бесполезны. Но, как будет
показано ниже, такие функции в Рефале-05 на столько часто нужны, что для их
записи предусмотрен синтаксический сахар. Ключевое слово `$ENUM` определяет
пустые локальные функции с заданными именами, `$EENUM` (entry enum) —
entry-функции. Запись

    $ENUM One, Two, Three;
    $EENUM Four, Five, Six;

эквивалентна

    One { }
    Two { }
    Three { }
    $ENTRY Four { }
    $ENTRY Five { }
    $ENTRY Six { }


Данные, обрабатываемые Рефалом, называются _объектными выражениями._ Объектное
выражение — это последовательность символов (неделимых элементов данных, атомов)
и _круглых скобок,_ причём круглые скобки должны быть сбалансированы.

_Символы_ делятся на три вида:

* символы-литеры — ASCII-символы: буквы, цифры, знаки препинания и арифметики,
  пробелы, переводы строк и прочие,
* символы-числа — неотрицательные числа меньше чем 2<super>N</super>, где N —
  число, зависящее от используемой платформы,
* символы-функции — имена функций из области видимости файла.


















