Установка и использование, конфигурирование, отладка
====================================================

Сборка компилятора
------------------

Готовых инсталляторов вроде setup.exe нет, компилятор нужно вручную собирать
из исходников и правильно настроить переменные окружения.

Исходные тексты можно загрузить со страницы репозитория на GitHub

<https://github.com/Mazdaywik/Refal-05>

кликнув по зелёной кнопке «Clone or download↓», либо, если у вас установлен
Git, склонировать его командой

    git clone https://github.com/Mazdaywik/Refal-05

Для дальнейшей раскрутки компилятора понадобятся установленные компиляторы
языка Си и [Рефала-5][PZ] или [Рефала-5λ][Lam].

Дальнейшие шаги зависят от операционной системы. На **POSIX-системах (Linux,
macOS)** достаточно запустить скрипт `./bootstrap.sh` (если установлен Рефал-5)
или `./bootstrap.sh lambda` (если установлен Рефал-5λ). После этого
автоматически будут созданы папка `bin` и файл `c-plus-plus.conf.sh`
с параметрами компилятора Си, используемого для раскрутки. По умолчанию
там указан компилятор `gcc` с опциями `-Wall -g`. При желании компилятор можно
поменять (по инструкциям в комментариях) и выполнить раскрутку ещё раз. Если
команда `gcc` в командной строке недоступна (используется какой-нибудь другой
компилятор Си), то раскрутка пройдёт неуспешно, нужно будет
в `c-plus-plus.conf.sh` вписать правильную команду для запуска компилятора Си.

**Примечание.** На macOS часто ставится только Clang, но при этом команда `gcc`
является псевдонимом для запуска Clang’а, поэтому никаких дополнительных
действий делать не требуется.

На **Windows** всё немного интереснее: компиляторов языка Си целый зоопарк,
а значит, некоторый «дефолтовый», который доступен почти везде, вписать
в конфигурационный файл нельзя. Поэтому установка выполняется в две стадии.
После первого запуска `bootstrap.bat` (если установлен Рефал-5) или
`bootstrap.bat lambda` (если установлен Рефал-5λ) установка завершится
заведомо с ошибкой и будет создан файл `c-plus-plus.conf.bat`. После этого
в него нужно вписать командную строку для запуска компилятора и вызвать
`bootstrap.bat`/`bootstrap.bat lambda` второй раз. В конфигурационном файле
уже есть закомментированные заготовки для запуска компиляторов BCC 5.5,
Visual C++, GCC, Clang и Watcom — их можно раскомментировать, уточнив пути
к папкам.

**Примечание.** Такой же механизм конфигурации для раскрутки (и не только
раскрутки) применяется в Рефале-5λ, только там используется компилятор C++.
Имя файла `c-plus-plus.conf.*` унаследовано оттуда. В следующих версиях
конфигурационный файл может быть переименован.


Установка и конфигурирование
----------------------------

После успешной раскрутки у Вас должна появиться папка `bin`, содержащая файл
`refal05c.exe` или `refal05c` со флагом исполнимости (в зависимости от ОС).
Этот файл и есть исполнимый файл компилятора — его уже (не выполняя следующих
шагов) можно использовать для трансляции исходников Рефала-05 в Си. Чтобы
его можно было запускать из любой папки, добавьте его в переменную окружения
`PATH` (настройка переменных окружения зависит от операционной системы,
поэтому мы не будем здесь давать подробных шагов).

Компилятор `refal05c` может не только выполнять трансляцию исходников в Си,
но и искать библиотеки по стандартным путям и вызывать компилятор Си для
получения готового исполнимого файла. Только его надо об этом проинструктировать.

Рефал-05 понимает следующие три переменные окружения:

* `R05CCOMP` — префикс командной строки для запуска компилятора Си. Примеры:
  `gcc -Wall -g -O3`, `bcc32 -w`, `cl /EHcs /W3 /wd4996 /O2` и т.д. Если
  переменная не установлена или пустая, запуск компилятора Си не выполняется.
* `R05CFLAGS` — дополнительные флаги компилятора Си. Используется для того,
  чтобы задать какую-либо опцию для конкретного запуска, не трогая `R05CCOMP`.
  Например, для GCC можно задавать имя исполнимого файла `-ofilename`, чтобы
  избежать стандартного имени `a.exe` или `a.out`.
* `R05PATH` — пути для поиска исходников, перечисляются через _точку с запятой_
  (не через двоеточие). Если задана переменная `R05CCOMP`, то эти же папки
  становятся путями поиска заголовочных файлов, т.е. передаются в командной
  строке как опции `-Iпапка`.

**Примечание.** На POSIX-системах (Linux или macOS) в переменную `R05CCOMP`
желательно добавлять `-DR05_POSIX` (например, `gcc -DR05_POSIX`) — в этом
случае функция `System` будет корректно возвращать код возврата. Без данного
флага работать всё равно всё будет, только `System` будет возвращать сырое
значение функции `system` языка Си, которое может отличаться от фактического
кода возврата (см. `man 2 wait` для более подробных сведений).

В переменной `R05PATH` нужно указать полные пути к папкам `lib` и `src` данного
репозитория, причём они должны быть доступны на запись (ограничение текущей
версии). Папку `lib` нужно указывать обязательно, чтобы компилятор мог находить
пути к файлам библиотеки поддержки времени выполнения («рантайм») и библиотеке
встроенных функций. Папка `src` опциональная — там находится вспомогательная
библиотека `LibraryEx` и компоненты компилятора.

Синтаксис командной строки очень простой — аргументами являются только имена
файлов, остальную конфигурацию компилятор берёт из переменных окружения.

Каждый файл, указанный в командной строке, последовательно ищется сначала
в текущей папке, а потом последовательно по каждому из путей, указанных
в `R05PATH`.

Если файл имеет расширение `.ref`, то он компилируется в одноимённый файл
с расширением `.c` в той папке, где он был найден (поэтому папки `lib` и `src`
должны быть доступны на запись). Если файл имеет расширение `.c`, то его
имя будет просто передано компилятору языка Си.

Расширения файлов можно опускать — если файл не заканчивается на `.ref` или
на `.c` (в нижнем регистре), то сначала к нему приписывается расширение `.ref`,
потом расширение `.c`.

**Пример.** Пусть компилятор установлен правильно (настроены `R05CCOMP`
и `R05PATH`) и записана такая командная строка:

    refal05c myprogram refal05rts Library LibraryEx

Компилятор в этом случае найдёт `myprogram.ref` в текущей папке, `refal05rts.c`
и `Library.ref` в папке `lib`, `LibraryEx.ref` в папке `src`. Будут созданы
файлы `myprogram.c` в текущей папке, `Library.c` в папке `lib` и `LibraryEx.c`
в папке `src`. Если задана непустая переменная `R05CCOMP`, будет вызван
компилятор Си, которому будут переданы четыре сишных файла и ключи `-I`
с путями к папкам `lib` и `src`.

Если вы пользуетесь компилятором Рефал-5 и раскрутка Рефала-05 производилась
с его помощью, в папке `bin` будут располагаться `.rsl`-файлы для всех файлов
каталога `src`, в частности, весьма полезная библиотека `LibraryEx`. Путь
к папке `bin` можно добавить к переменной окружения `REF5RSL`.


[PZ]: http://www.botik.ru/pub/local/scp/refal5/
[Lam]: https://bmstu-iu9.github.io/refal-5-lambda/
