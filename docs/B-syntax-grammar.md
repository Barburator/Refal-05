Формальное описание лексики и грамматики Рефала-05
==================================================

В этом разделе описана лексика и грамматика Рефала-05 в формальном виде:
лексические единицы описаны при помощи регулярных выражений, грамматическая
структура — при помощи нотации Вирта (вариант РБНФ).

Семантика в этом разделе не описывается.

Неформальное описание синтаксиса и лексики вместе с семантикой дано [во второй
части](2-syntax.md) этого руководства.

Лексическая структура языка
---------------------------

Компилятор работает по принципу максимального куска — на каждой итерации
он пытается откусить префикс, соответствующий лексической единице (лексическому
домену) максимальной длины. Исключение — псевдокомментарий, который сначала
анализируется как строка определённого вида, а затем для его содержимого
рекурсивно вызывается лексер.

Соглашение о записи регулярных выражений:

* Символы `^` и `$` означают начало и конец строки.
* Наборы символов записываются в квадратных скобках: `[...]`. Если внутри
  квадратной скобки надо записать диапазон, то он будет записываться через
  дефис: `[0-9]`, `[A-Za-z]`. Дополнение множества будет обозначаться как
  знак `^` после `[`, например — `[^@#$]` — любые символы, кроме собаки,
  решётки и доллара. Допустимы escape-последовательности: `\t` — табуляция
  `\n` — новая строка, `\r` — возврат каретки, `\\` — обратная косая
  черта, `\-` — дефис.
* Круглые скобки `(`, `)` используются для группировки.
* Вертикальная черта `|` означает альтернативу.
* Если после элемента регулярного выражения (символа, группы или набора)
  располагается знак `*`, `+` или `?`, данный элемент повторяется,
  соответственно, 0 и более, 1 и более или 0 или 1 раз.
* Фигурные скобки с фразой внутри являются псевдокодом для записи некоторых
  понятий, например `{any keyword}` означает любое корректное ключевое
  слово.
* Escape-последовательности: `\t`, `\n`, `\r` с известным смыслом, `\\` —
  обратная косая черта, `\[`, `\(`, `\)`, `\|`, `\*`, `\+`, `\?`, `\{`,
  `\}` означают соответствующие символы, записанные буквально.
* `.` означает любой символ, кроме перевода строки.
* Любой другой символ записывается самим собой.

Язык регулярных выражений ограничен, в нём намеренно нет некоторых известных
конструкций (например, шестнадцатеричных кодов), но его достаточно для описания
лексики.

Символы свободного пространства, компилятором игнорируются:

    [ \t\n\r]*

Ключевые слова:

    \$ENTRY
    \$EXTERN
    \$ENUM
    \$EENUM

Знаки пунктуации:

    \(
    \)
    ,
    ;
    <
    =
    >
    \{
    \}

Псевдокомментарий — однострочный комментарий, который должен начинаться
с корректного ключевого слова, после которого могут располагаться
произвольные токены. Для его интерпретации лексический анализатор приписывает
в конец строки знак `;` и вызывает себя рекурсивно. Полученные токены (включая
ключевое слово в начале) рассматриваются как обычные токены.

    ^\*{any keyword}{any token}*

Однострочный комментарий, игнорируется компилятором, если не начинается
с ключевого слова, т.е. не является псевдокомментарием.

    ^\*.*\n

Многострочный комментарий — начинается на `/*`, заканчивается на `*/`, не может
содержать внутри себя `/*`:

    /\*([^/*]|/+[^*]|\*+[^/])*\*/

Имя (в грамматике будет обозначен как `NAME`) — последовательность латинских
букв, цифр и знаков `-` и `_`, начинающаяся с буквы, знаки `-` и `_` считаются
взаимозаменяемыми:

    [A-Za-z][A-Za-z0-9_\-]*

Целое число (в грамматике будет обозначен как `NUMBER`) — последовательность
десятичных цифр:

    [0-9]+

Цепочка литер — начинается с `'`, заканчивается на `'`, между ними записана
последовательность образов литер, возможно пустая. Литеры «табуляция», «перевод
строки», «возврат каретки», `'`, `\` изображаются как `\t`, `\n`, `\r`, `\'`,
`\\`, остальные печатные литеры набора ASCII представляются сами собой. Литеры
`"`, `<`, `>`, `(`, `)` могут изображаться как `\"`, `\<`, `\>`, `\(`, `\)`,
но это не обязательно. Литера с шестнадцатеричным кодом HH изображается как
`\xHH`, где H — одна из шестнадцатеричных цифр: 0…9, A…F, a…f. Запись в кавычках
литер вне набора ASCII допустима, но непереносима. Каждая литера из цепочки
трактуется как отдельный токен, в грамматике такие токены будут изображаться
как `CHAR`.

    '(\\[tnr'\\"<>()]|\\x[0-9A-Za-z][0-9A-Za-z])|[^'\\\n])*'

Переменные (в грамматике — `VARIABLE`) начинаются с индикатора типа — буквы `s`,
`t` или `e`, за которой следует точка и индекс переменной — последовательность
латинских букв, цифр, знаков `-` и `_`, причём знаки `-` и `_` считаются
взаимозаменяемыми:

    [ste]\.[A-Za-z0-9_\-]+

Нативная вставка (в грамматике — `NATIVE`) — последовательность строк, которая
начинается и заканчивается строкой `%%`, внутри нативной вставки `%%`
недопустима:

    ^%%\n(([^%\n].*|%|%[^%\n].*)?\n)*%%\n


Грамматика Рефала-05
--------------------

Для описания грамматики будет использоваться нотация Вирта — вариант РБНФ,
который использует Николаус Вирт в своих статьях для описания синтаксиса языков
(в частности, Модулы и Оберона). Лексические единицы в ней изображаются либо
словами в верхнем регистре (например, `NAME`), либо их записью в программе,
завёрнутой в кавычки (например, `"("`, `"$ENTRY"` и т.д.). Альтернатива
записывается вертикальной чертой `|`. Круглые скобки `(`, `)` используются
только для задания приоритета, фигурные скобки `{`, `}` означают, что их
содержимое повторяется 0 или более раз, квадратные скобки `[`, `]` — ноль или
один раз. Имена грамматических конструкций записываются как последовательности
латинских букв в ВерблюжьемРегистре. Правила состоят из левой и правой частей,
разделённых знаком равенства `=`, слева записывается имя грамматической
конструкции, справа — её описание, заканчиваются на точку `.`.

Нотация Вирта в нотации Вирта:

    Grammar = { Rule }.
    Rule = NAME "=" Description ".".
    Description = { DescriptionItem }.
    DescriptionItem = LexicItem | NAME | Group.
    LexicItem = CAPNAME | INQUOTES.
    Group = "(" Description ")" | "{" Description "}" | "[" Description "]".

Программа на Рефале-05 является последовательностью объявлений, определений
и нативных вставок, также допустимо любое количество незначащих точек с запятой
на верхнем уровне:

    Program = { Declaration | Definition | NATIVE | ";" }.

Объявление записывается как ключевое слово `$EXTERN`, за которым перечислены
имена через запятую, завершается точкой с запятой:

    Declaration = "$EXTERN" NameList ";".
    NameList = NAME {"," NAME} .

Определение — это либо определение пустых функций, либо определение обычной
функции:

    Definition = EmptyDefinition | Function.

Определение пустых функций записывается также, как и объявление, только вместо
ключевого слова `$EXTERN` используются слова `$ENUM` и `$EENUM`:

    EmptyDefinition = ("$ENUM" | "$EENUM") NameList ";".

Функция записывается как имя функции, за которой в фигурных скобках записывается
тело функции. Перед именем функции может располагаться ключевое слово `$ENTRY`:

    Function = ["$ENTRY"] NAME "{" Body "}".

Тело функции — это или нативная вставка, или последовательность предложений,
возможно пустая:

    Body = NATIVE | [ Sentences ].

Предложения разделяются точкой с запятой, после последнего предложения точка
с запятой необязательна.

    Sentences = Sentence { ";" Sentence } [";"].

Предложение — левая и правая часть (образец и результат, соответственно),
разделённые знаком `=`:

    Sentence = Pattern "=" Result.

Образец (образцовое выражение) — последовательность символов, переменных
и образцовых выражений, заключённых в круглые скобки:

    Pattern = { Symbol | VARIABLE | "(" Pattern ")" }.

Результат (результатное выражение) — последовательность символов, переменных
и результатных выражений, заключённых в круглые или угловые скобки:

    Result = { Symbol | VARIABLE | "(" Result ")" | "<" Result ">" }.

Символ — имя, число или литера:

    Symbol = NAME | NUMBER | CHAR.
